<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eenvoudige Asset Manager (Lokaal HTML/JS)</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;margin:0;padding:0}
    body{max-width:1100px;margin:24px auto;padding:20px}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:#444}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px}
    label{display:block;margin-top:8px;font-size:13px}
    input[type=text], textarea, select{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px}
    .controls{display:flex;gap:8px;margin-top:10px}
    button{padding:8px 10px;border-radius:6px;border:1px solid #888;background:#f7f7f7;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    .small{font-size:12px;padding:6px 8px}
    .field-row{display:flex;gap:8px;align-items:center}
    .field-row input{flex:1}
    .list{max-height:420px;overflow:auto;margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eee;font-size:13px}
    .qr-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    .muted{color:#666;font-size:13px}
    .inline{display:inline-block}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .notice{background:#fffbeb;border:1px solid #f5e1a8;padding:8px;border-radius:6px;margin-bottom:12px}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <div class="topbar">
    <div>
      <h1>Eenvoudige Asset Manager — Lokaal HTML/JS</h1>
      <p class="lead">Maak dynamische formulieren, sla assets op in localStorage of exporteer CSV/JSON, genereer QR-codes. Geen server nodig.</p>
    </div>
    <div class="muted">Tip: open dit bestand in je browser. Gegevens worden opgeslagen in de <strong>localStorage</strong> van je browser en kunnen worden geëxporteerd/geïmporteerd.</div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Asset Formulier</strong>
          <div class="muted">Record-ID: <span id="currentId">(nieuw)</span></div>
        </div>

        <div id="formFields"></div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="addFieldBtn" class="small">+ Voeg veld toe</button>
          <button id="saveAssetBtn" class="primary">Asset opslaan</button>
          <button id="clearFormBtn" class="small">Formulier wissen</button>
          <label class="small inline" style="margin-left:8px"><input id="embedInQR" type="checkbox"/> Volledige data in QR opnemen</label>
        </div>

        <hr/>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="exportCSV" class="small">Exporteer CSV</button>
          <button id="exportJSON" class="small">Exporteer JSON</button>
          <input id="importFile" type="file" accept="application/json,text/csv" style="display:inline-block" />
        </div>

      </div>

      <div class="card" style="margin-top:12px">
        <strong>Assets</strong>
        <div class="list" id="assetsList"></div>
      </div>

    </div>

    <div>
      <div class="card">
        <strong>QR / Voorbeeld</strong>
        <div class="qr-wrap" style="margin-top:10px">
          <canvas id="qrcanvas" width="256" height="256"></canvas>
          <div class="muted">Scan de QR om de asset te bekijken of op te halen. Je kunt kiezen om de volledige data direct in de QR op te nemen of enkel een korte referentie (<code>asset://&lt;id&gt;</code>).</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="downloadQR" class="small">Download QR PNG</button>
            <button id="downloadAssetJSON" class="small">Download asset JSON</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Instructies</strong>
        <ol style="padding-left:18px">
          <li>Maak velden aan met <em>+ Voeg veld toe</em> of bewerk de standaardvelden.</li>
          <li>Sla een asset op. De gegevens worden lokaal opgeslagen in je browser.</li>
          <li>Exporteer naar CSV/JSON voor back-ups of om later te importeren.</li>
          <li>Host <strong>viewer.html</strong> (bijv. op GitHub Pages) en genereer QR's die naar die viewer verwijzen met de volledige data.</li>
        </ol>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // Velden - standaard
    const DEFAULT_FIELDS = [
      {key:'naam', label:'Naam'},
      {key:'categorie', label:'Categorie'},
      {key:'locatie', label:'Locatie'},
      {key:'serienummer', label:'Serienummer'},
      {key:'opmerkingen', label:'Opmerkingen', type:'textarea'}
    ];

    // Utilities
    const uid = ()=> 'a'+Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    const DB_KEY = 'assets_db_v1';

    // State
    let schema = JSON.parse(localStorage.getItem('assets_schema_v1')||'null') || DEFAULT_FIELDS.slice();
    let db = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
    let currentEditingId = null;

    // Elements
    const formFieldsEl = document.getElementById('formFields');
    const assetsListEl = document.getElementById('assetsList');
    const currentIdEl = document.getElementById('currentId');
    const embedInQR = document.getElementById('embedInQR');
    const qrcanvas = document.getElementById('qrcanvas');

    function renderForm(){
      formFieldsEl.innerHTML = '';
      schema.forEach((f, idx)=>{
        const row = document.createElement('div');
        row.className = 'field-row';
        const id = 'field_'+idx;
        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = f.label || f.key;

        let input;
        if(f.type === 'textarea'){
          input = document.createElement('textarea');
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = 'text';
        }
        input.id = id;
        input.dataset.key = f.key;
        input.placeholder = f.label || f.key;

        const del = document.createElement('button');
        del.textContent = '✕';
        del.className = 'small';
        del.style.height = '34px';
        del.onclick = ()=>{
          if(confirm('Veld "'+(f.label||f.key)+'" verwijderen?')){
            schema.splice(idx,1); saveSchema(); renderForm();
          }
        };

        const meta = document.createElement('div');
        meta.style.flex='1';
        meta.appendChild(label);
        meta.appendChild(input);
        row.appendChild(meta);
        row.appendChild(del);
        formFieldsEl.appendChild(row);
      });
    }

    function saveSchema(){ localStorage.setItem('assets_schema_v1', JSON.stringify(schema)); }

    function readForm(){
      const obj = {};
      formFieldsEl.querySelectorAll('input,textarea').forEach(i=>{ obj[i.dataset.key] = i.value || ''; });
      return obj;
    }

    function populateForm(data){
      formFieldsEl.querySelectorAll('input,textarea').forEach(i=>{ i.value = data[i.dataset.key] || ''; });
    }

    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(db)); }

    function addDefaultValues(record){ schema.forEach(f=>{ if(!(f.key in record)) record[f.key]=''; }); return record; }

    function saveAsset(){
      const data = readForm();
      if(!data.naam && !data.serienummer){ if(!confirm('Geen naam of serienummer ingevoerd. Toch opslaan?')) return; }
      if(currentEditingId){
        const idx = db.findIndex(r=>r._id===currentEditingId);
        if(idx>=0){ db[idx] = Object.assign(db[idx], data); db[idx].modified = new Date().toISOString(); }
      } else {
        const record = addDefaultValues(Object.assign({}, data));
        record._id = uid(); record.created = new Date().toISOString();
        db.push(record);
        currentEditingId = record._id;
      }
      saveDB(); renderList(); currentIdEl.textContent = currentEditingId || '(nieuw)'; renderQRForCurrent(); alert('Opgeslagen. (ook opgeslagen in browser localStorage)');
    }

    function renderList(){
      if(db.length===0){ assetsListEl.innerHTML = '<div class="muted">Nog geen assets.</div>'; return; }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr><th>ID</th><th>Naam</th><th>Serienummer</th><th>Acties</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      db.slice().reverse().forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style=\"font-family:monospace\">${r._id}</td><td>${escapeHtml(r.naam||'—')}</td><td>${escapeHtml(r.serienummer||'—')}</td>`;
        const actionsTd = document.createElement('td');
        const viewBtn = document.createElement('button'); viewBtn.textContent='Bekijk'; viewBtn.className='small';
        viewBtn.onclick = ()=>{ currentEditingId = r._id; populateForm(r); currentIdEl.textContent = currentEditingId; renderQRForCurrent(); };
        const delBtn = document.createElement('button'); delBtn.textContent='Verwijder'; delBtn.className='small'; delBtn.onclick = ()=>{ if(confirm('Asset verwijderen?')){ db = db.filter(x=>x._id!==r._id); saveDB(); renderList(); if(currentEditingId===r._id){ currentEditingId=null; currentIdEl.textContent='(nieuw)'; renderForm(); } } };
        const qrBtn = document.createElement('button'); qrBtn.textContent='Maak QR'; qrBtn.className='small'; qrBtn.onclick = ()=>{ currentEditingId = r._id; populateForm(r); currentIdEl.textContent = currentEditingId; renderQRForCurrent(); };
        actionsTd.appendChild(viewBtn); actionsTd.appendChild(qrBtn); actionsTd.appendChild(delBtn);
        tr.appendChild(actionsTd);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      assetsListEl.innerHTML=''; assetsListEl.appendChild(table);
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]; }); }

    function renderQRForCurrent(){
      const canvas = qrcanvas;
      const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height);
      if(!currentEditingId){ ctx.fillStyle='#f3f3f3'; ctx.fillRect(0,0,canvas.width,canvas.height); return; }
      const record = db.find(r=>r._id===currentEditingId) || addDefaultValues(readForm());
      const shouldEmbed = embedInQR.checked;
      let payload;
      if(shouldEmbed){ payload = JSON.stringify(record); }
      else { payload = `asset://${record._id}`; }

      // generate QR: use the QRCode library by creating a temporary div and drawing its image onto our canvas
      const tmp = document.createElement('div');
      tmp.style.display='none';
      document.body.appendChild(tmp);
      new QRCode(tmp, {text: payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M});
      setTimeout(()=>{
        const img = tmp.querySelector('img');
        if(img){ ctx.drawImage(img,0,0,canvas.width,canvas.height); }
        else {
          const table = tmp.querySelector('table');
          if(table){ const s = new XMLSerializer().serializeToString(table);
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><foreignObject width='100%' height='100%'>${s}</foreignObject></svg>`;
            const img2 = new Image(); img2.onload = ()=>ctx.drawImage(img2,0,0,canvas.width,canvas.height); img2.src = 'data:image/svg+xml;charset=utf-8,'+encodeURIComponent(svg);
          }
        }
        tmp.remove();
      },100);
    }

    // Download helpers
    function download(filename, text){ const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'})); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); }

    function exportCSV(){ if(db.length===0){ alert('Geen assets om te exporteren'); return; }
      const cols = schema.map(s=>s.key).concat(['_id','created','modified']);
      const lines = [cols.join(',')];
      db.forEach(r=>{ const row = cols.map(c=>escapeCsv((r[c]||'')+'')); lines.push(row.join(',')); });
      download('assets_export.csv', lines.join('\n'));
    }

    function escapeCsv(s){ if(s==null) return ''; if(s.indexOf(',')>=0 || s.indexOf('\n')>=0 || s.indexOf('"')>=0) return '"'+s.replace(/"/g,'""')+'"'; return s; }

    function exportJSON(){ download('assets_export.json', JSON.stringify(db, null, 2)); }

    function importFile(file){ const reader = new FileReader(); reader.onload = e=>{
        const txt = e.target.result;
        try{
          if(file.name.endsWith('.csv')){
            const parsed = parseCSV(txt);
            parsed.forEach(r=>{ if(!r._id) r._id = uid(); db.push(r); });
          } else {
            const parsed = JSON.parse(txt);
            if(Array.isArray(parsed)) parsed.forEach(r=>{ if(!r._id) r._id = uid(); db.push(parsed.shift()); });
            else if(typeof parsed === 'object') { if(!parsed._id) parsed._id = uid(); db.push(parsed); }
          }
          saveDB(); renderList(); alert('Geïmporteerd.');
        } catch(err){ alert('Importeren mislukt: '+err); }
      };
      reader.readAsText(file);
    }

    function parseCSV(txt){ const lines = txt.split(/\r?\n/).filter(l=>l.trim().length>0); if(lines.length<1) return []; const headers = csvSplit(lines[0]); const out = []; for(let i=1;i<lines.length;i++){ const cols = csvSplit(lines[i]); const obj = {}; headers.forEach((h,idx)=>{ obj[h]=cols[idx]||''; }); out.push(obj); } return out; }
    function csvSplit(line){ const res = []; let cur=''; let inQuotes=false; for(let i=0;i<line.length;i++){ const ch = line[i]; if(inQuotes){ if(ch==='"'){ if(line[i+1]==='"'){ cur+='"'; i++; } else inQuotes=false; } else cur+=ch; } else { if(ch==='"'){ inQuotes=true; } else if(ch===','){ res.push(cur); cur=''; } else cur+=ch; } } res.push(cur); return res; }

    // Events
    document.getElementById('addFieldBtn').onclick = ()=>{
      const key = prompt('Sleutel voor veld (geen spaties, gebruikt als kolomnaam):'); if(!key) return; const label = prompt('Label (mensvriendelijk):', key) || key; const type = confirm('Groot tekstvak? OK = textarea, Annuleer = enkele regel') ? 'textarea' : 'text'; schema.push({key:key.replace(/\s+/g,'_'), label, type}); saveSchema(); renderForm(); };
    document.getElementById('saveAssetBtn').onclick = saveAsset;
    document.getElementById('clearFormBtn').onclick = ()=>{ if(confirm('Huidig formulier wissen?')){ currentEditingId=null; currentIdEl.textContent='(nieuw)'; formFieldsEl.querySelectorAll('input,textarea').forEach(i=>i.value=''); renderQRForCurrent(); } };
    document.getElementById('exportCSV').onclick = exportCSV;
    document.getElementById('exportJSON').onclick = exportJSON;
    document.getElementById('importFile').onchange = (e)=>{ const f = e.target.files[0]; if(f) importFile(f); e.target.value=''; };
    document.getElementById('downloadQR').onclick = ()=>{ const link = document.createElement('a'); link.href = qrcanvas.toDataURL('image/png'); link.download = (currentEditingId||'asset') + '.png'; link.click(); };
    document.getElementById('downloadAssetJSON').onclick = ()=>{ const record = db.find(r=>r._id===currentEditingId) || addDefaultValues(readForm()); download((currentEditingId||'asset')+'.json', JSON.stringify(record,null,2)); };

    embedInQR.onchange = ()=> renderQRForCurrent();

    // init
    (function init(){ renderForm(); renderList(); renderQRForCurrent(); if(db.length>0) { currentEditingId = db[db.length-1]._id; currentIdEl.textContent = currentEditingId; populateForm(db[db.length-1]); renderQRForCurrent(); } })();

    // hotkeys
    formFieldsEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) { e.preventDefault(); saveAsset(); } });

  </script>
</body>
</html>
